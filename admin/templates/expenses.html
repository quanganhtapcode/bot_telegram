<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bot Admin - Qu·∫£n l√Ω Giao d·ªãch</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
      .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 16px; margin-bottom: 24px; }
      .stat-card { border: 1px solid #eee; border-radius: 8px; padding: 16px; background: #fafafa; }
      .expenses-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .expenses-table th, .expenses-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
      .expenses-table th { background: #f8f9fa; font-weight: 600; }
      .expenses-table tr:hover { background: #f8f9fa; }
      .amount { font-family: monospace; font-weight: 600; }
      .currency { color: #666; font-size: 0.9em; }
      .delete-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
      .delete-btn:hover { background: #c82333; }
      .muted { color: #666; }
      .success { color: #28a745; background: #d4edda; padding: 8px 12px; border-radius: 4px; margin-bottom: 16px; }
      .error { color: #721c24; background: #f8d7da; padding: 8px 12px; border-radius: 4px; margin-bottom: 16px; }
      .nav-links { margin-bottom: 16px; }
      .nav-links a { color: #0d6efd; text-decoration: none; margin-right: 16px; }
      .nav-links a:hover { text-decoration: underline; }
      .limit-controls { margin-bottom: 16px; }
      .limit-controls form { display: inline-block; margin-right: 16px; }
      .limit-controls input[type="number"] { width: 80px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; }
      .limit-controls button { background: #007bff; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; }
      .limit-controls button:hover { background: #0056b3; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Qu·∫£n l√Ω Giao d·ªãch</h1>
      <div>
        <a href="/">‚Üê Dashboard</a>
      </div>
    </div>

    <div class="nav-links">
      <a href="/users">Users</a>
      <a href="/expenses/stats">üìä Th·ªëng k√™</a>
      <a href="/logs">Logs</a>
    </div>

    <!-- Th√¥ng b√°o -->
    {% if request.query_params.get("deleted") %}
    <div class="success">‚úÖ Giao d·ªãch ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!</div>
    {% endif %}
    
    {% if request.query_params.get("error") %}
    <div class="error">‚ùå L·ªói: {{ request.query_params.get("error") }}</div>
    {% endif %}

    <!-- Th·ªëng k√™ -->
    <div class="stats">
      <div class="stat-card">
        <h3>Giao d·ªãch (30 ph√∫t)</h3>
        <div style="font-size: 24px; font-weight: 700; color: #dc3545;">{{ half_hour_count }}</div>
        <div class="muted">C·ª±c k·ª≥ g·∫ßn ƒë√¢y</div>
      </div>
      <div class="stat-card">
        <h3>Giao d·ªãch (1 gi·ªù)</h3>
        <div style="font-size: 24px; font-weight: 700; color: #ff6b35;">{{ hour_count }}</div>
        <div class="muted">R·∫•t g·∫ßn ƒë√¢y</div>
      </div>
      <div class="stat-card">
        <h3>Giao d·ªãch (24h)</h3>
        <div style="font-size: 24px; font-weight: 700; color: #28a745;">{{ recent_count }}</div>
        <div class="muted">C√≥ th·ªÉ ho√†n t√°c</div>
      </div>
      <div class="stat-card">
        <h3>Giao d·ªãch (7 ng√†y)</h3>
        <div style="font-size: 24px; font-weight: 700;">{{ week_count }}</div>
        <div class="muted">T·ªïng c·ªông</div>
      </div>
      <div class="stat-card">
        <h3>Hi·ªÉn th·ªã</h3>
        <div style="font-size: 24px; font-weight: 700;">{{ limit }}</div>
        <div class="muted">Giao d·ªãch</div>
      </div>
    </div>

    <!-- ƒêi·ªÅu khi·ªÉn gi·ªõi h·∫°n -->
    <div class="limit-controls">
      <form method="GET" action="/expenses">
        <label>Hi·ªÉn th·ªã: </label>
        <input type="number" name="limit" value="{{ limit }}" min="10" max="1000" step="10">
        <button type="submit">C·∫≠p nh·∫≠t</button>
      </form>
      <a href="/expenses?limit=50">50</a> |
      <a href="/expenses?limit=100">100</a> |
      <a href="/expenses?limit=200">200</a> |
      <a href="/expenses?limit=500">500</a>
    </div>

    <!-- B·∫£ng giao d·ªãch -->
    <table class="expenses-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ng∆∞·ªùi chi</th>
          <th>Chuy·∫øn ƒëi</th>
          <th>S·ªë ti·ªÅn</th>
          <th>Ghi ch√∫</th>
          <th>Th·ªùi gian</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr>
          <td><strong>#{{ expense[0] }}</strong></td>
          <td>{{ expense[9] or "N/A" }}</td>
          <td>{{ expense[10] or "N/A" }}</td>
          <td>
            <span class="amount">{{ "{:,.2f}".format(expense[3]) }}</span>
            <span class="currency">{{ expense[4] }}</span>
          </td>
          <td>{{ expense[5] or "-" }}</td>
          <td>
            <div>{{ expense[6][:19] if expense[6] else "N/A" }}</div>
            <div class="muted" style="font-size: 0.9em;">
              {% if expense[6] %}
                {% set created_time = expense[6] %}
                {% if created_time.endswith('+00:00') %}
                  {{ created_time[:-6] }}
                {% else %}
                  {{ created_time }}
                {% endif %}
              {% endif %}
            </div>
            {% if expense[1] %}
            <div style="margin-top: 4px;">
              <a href="/expenses/trip/{{ expense[1] }}" style="font-size: 0.8em; color: #007bff;">
                üëÅÔ∏è Xem chuy·∫øn ƒëi
              </a>
            </div>
            {% endif %}
          </td>
          <td>
            <form method="POST" action="/expenses/{{ expense[0] }}/delete" style="display: inline;" 
                  onsubmit="return confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?\n\n- H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c\n- T·∫•t c·∫£ d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn\n- C√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn t√≠nh to√°n n·ª£ v√† chi ti√™u\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')">
              <button type="submit" class="delete-btn">üóëÔ∏è X√≥a</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if not expenses %}
    <div style="text-align: center; padding: 40px; color: #666;">
      <p>Kh√¥ng c√≥ giao d·ªãch n√†o.</p>
    </div>
    {% endif %}

    <script>
      // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 5 gi√¢y
      setTimeout(function() {
        const notifications = document.querySelectorAll('.success, .error');
        notifications.forEach(function(notification) {
          notification.style.display = 'none';
        });
      }, 5000);
    </script>
  </body>
</html>
