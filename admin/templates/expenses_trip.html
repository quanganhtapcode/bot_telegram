<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bot Admin - Giao d·ªãch Chuy·∫øn ƒëi</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
      .nav-links { margin-bottom: 16px; }
      .nav-links a { color: #0d6efd; text-decoration: none; margin-right: 16px; }
      .nav-links a:hover { text-decoration: underline; }
      .trip-info { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 24px; }
      .trip-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 16px; margin: 20px 0; }
      .stat-card { border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; background: white; text-align: center; }
      .stat-number { font-size: 28px; font-weight: 700; color: #007bff; }
      .stat-label { color: #6c757d; font-size: 0.9em; }
      .members-list { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
      .member-item { display: inline-block; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px 12px; margin: 4px; }
      .member-role { font-size: 0.8em; color: #6c757d; }
      .admin-role { color: #dc3545; font-weight: 600; }
      .expenses-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .expenses-table th, .expenses-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
      .expenses-table th { background: #f8f9fa; font-weight: 600; }
      .expenses-table tr:hover { background: #f8f9fa; }
      .amount { font-family: monospace; font-weight: 600; }
      .currency { color: #666; font-size: 0.9em; }
      .delete-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
      .delete-btn:hover { background: #c82333; }
      .muted { color: #666; }
      .success { color: #28a745; background: #d4edda; padding: 8px 12px; border-radius: 4px; margin-bottom: 16px; }
      .error { color: #721c24; background: #f8d7da; padding: 8px 12px; border-radius: 4px; margin-bottom: 16px; }
      .warning { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin-bottom: 24px; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Giao d·ªãch Chuy·∫øn ƒëi</h1>
      <div>
        <a href="/expenses">‚Üê Quay l·∫°i</a>
      </div>
    </div>

    <div class="nav-links">
      <a href="/">Dashboard</a>
      <a href="/expenses">Qu·∫£n l√Ω giao d·ªãch</a>
      <a href="/expenses/stats">üìä Th·ªëng k√™</a>
      <a href="/users">Users</a>
      <a href="/logs">Logs</a>
    </div>

    <!-- Th√¥ng b√°o -->
    {% if request.query_params.get("deleted") %}
    <div class="success">‚úÖ Giao d·ªãch ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!</div>
    {% endif %}
    
    {% if request.query_params.get("error") %}
    <div class="error">‚ùå L·ªói: {{ request.query_params.get("error") }}</div>
    {% endif %}

    <!-- Th√¥ng tin chuy·∫øn ƒëi -->
    <div class="trip-info">
      <h2>{{ trip[2] }}</h2>
      <p class="muted">
        <strong>M√£:</strong> {{ trip[1] }} | 
        <strong>Ti·ªÅn t·ªá c∆° b·∫£n:</strong> {{ trip[3] }} | 
        <strong>Ng√†y t·∫°o:</strong> {{ trip[5][:19] if trip[5] else "N/A" }}
      </p>
      
      <div class="trip-stats">
        <div class="stat-card">
          <div class="stat-number">{{ total_expenses }}</div>
          <div class="stat-label">T·ªïng giao d·ªãch</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ "{:,.0f}".format(total_amount) }}</div>
          <div class="stat-label">T·ªïng ti·ªÅn ({{ trip[3] }})</div>
        </div>
      </div>
    </div>

    <!-- Danh s√°ch th√†nh vi√™n -->
    <div class="members-list">
      <h3>üë• Th√†nh vi√™n ({{ members|length }})</h3>
      {% for member in members %}
      <div class="member-item">
        <strong>{{ member[0] }}</strong>
        <span class="member-role {% if member[1] == 'admin' %}admin-role{% endif %}">
          ({{ member[1] }})
        </span>
      </div>
      {% endfor %}
    </div>

    <!-- C·∫£nh b√°o v·ªÅ ho√†n t√°c -->
    <div class="warning">
      <h4>‚ö†Ô∏è L∆∞u √Ω khi ho√†n t√°c giao d·ªãch trong chuy·∫øn ƒëi:</h4>
      <ul>
        <li>Ho√†n t√°c giao d·ªãch s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn t√≠nh to√°n n·ª£ c·ªßa t·∫•t c·∫£ th√†nh vi√™n</li>
        <li>N·∫øu giao d·ªãch ƒë√£ ƒë∆∞·ª£c chia s·∫ª, vi·ªác ho√†n t√°c c√≥ th·ªÉ l√†m m·∫•t c√¢n b·∫±ng</li>
        <li>N√™n th√¥ng b√°o cho t·∫•t c·∫£ th√†nh vi√™n tr∆∞·ªõc khi ho√†n t√°c</li>
        <li>Ch·ªâ ho√†n t√°c khi th·ª±c s·ª± c·∫ßn thi·∫øt v√† c√≥ s·ª± ƒë·ªìng thu·∫≠n</li>
      </ul>
    </div>

    <!-- B·∫£ng giao d·ªãch -->
    <h3>üìã Danh s√°ch giao d·ªãch</h3>
    {% if expenses %}
    <table class="expenses-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ng∆∞·ªùi chi</th>
          <th>S·ªë ti·ªÅn</th>
          <th>Ghi ch√∫</th>
          <th>Th·ªùi gian</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr>
          <td><strong>#{{ expense[0] }}</strong></td>
          <td>{{ expense[9] or "N/A" }}</td>
          <td>
            <span class="amount">{{ "{:,.2f}".format(expense[3]) }}</span>
            <span class="currency">{{ expense[4] }}</span>
            <br>
            <small class="muted">‚âà {{ "{:,.2f}".format(expense[8]) }} {{ trip[3] }}</small>
          </td>
          <td>{{ expense[5] or "-" }}</td>
          <td>
            <div>{{ expense[6][:19] if expense[6] else "N/A" }}</div>
            <div class="muted" style="font-size: 0.9em;">
              {% if expense[6] %}
                {% set created_time = expense[6] %}
                {% if created_time.endswith('+00:00') %}
                  {{ created_time[:-6] }}
                {% else %}
                  {{ created_time }}
                {% endif %}
              {% endif %}
            </div>
          </td>
          <td>
            <form method="POST" action="/expenses/{{ expense[0] }}/delete" style="display: inline;" 
                  onsubmit="return confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?\n\n- H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c\n- S·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn t√≠nh to√°n n·ª£ c·ªßa chuy·∫øn ƒëi\n- T·∫•t c·∫£ d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')">
              <button type="submit" class="delete-btn">üóëÔ∏è X√≥a</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #666;">
      <p>Ch∆∞a c√≥ giao d·ªãch n√†o trong chuy·∫øn ƒëi n√†y.</p>
    </div>
    {% endif %}

    <script>
      // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 5 gi√¢y
      setTimeout(function() {
        const notifications = document.querySelectorAll('.success, .error');
        notifications.forEach(function(notification) {
          notification.style.display = 'none';
        });
      }, 5000);
    </script>
  </body>
</html>
